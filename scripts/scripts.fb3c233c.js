"use strict";angular.module("promodoroApp",["ngAnimate","ngRoute","ngSanitize","ngTouch","ui.bootstrap"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl as mainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("promodoroApp").controller("MainCtrl",["$scope","TimeParser","TimerSettings","Notifier","$rootScope","Timer","Pomodoro",function(a,b,c,d,e,f,g){var h=this;h.states={started:!1,paused:!0,btn:"paused",background:"active",settings:!1,allowNotifactions:!1,showPro:!1},h.models={desktopNotification:c.getNotification("desktop"),audioNotifications:c.getNotification("audio"),activeTime:c.getTime("active")/60,shortBreak:c.getTime("shortBreak")/60,longBreak:c.getTime("longBreak")/60,count:0},h.init=function(){h.pomodoro=new g(function(a){h.setTime(a)}),h.time=b.parse(h.pomodoro.getDuration()),h.states.allowNotifactions=h.pomodoro.noticaftions(),h.timerState=h.setTimerState(),h.pomodoro.allowNotifaction(h.models.desktopNotification,h.models.audioNotifications)},h.isPaused=function(){return"paused"===h.states.btn},h.setTime=function(c){h.time=b.parse(c),a.$apply()},h.toggleTimer=function(){h.states.started?h.pomodoro.isPaused()?(h.states.paused=!1,h.closeSettings(),h.pomodoro.resume()):(h.states.paused=!0,h.pomodoro.pause()):(h.states.started=!0,h.states.paused=!1,h.closeSettings(),h.pomodoro.start()),h.timerState=h.setTimerState()},h.setTimerState=function(){return h.states.started?h.states.paused?"weiter":"pause":"start"},h.toggleSettings=function(){h.states.settings=!h.states.settings},h.closeSettings=function(){h.states.settings=!1},h.allowDesktopNotifications=function(){h.pomodoro._notifier.grantPermission(),c.setNotification("desktop",h.models.desktopNotification),h.pomodoro.allowNotifaction(h.models.desktopNotification)},h.toggleAudioNotifications=function(){c.setNotification("audio",h.models.audioNotifications),h.pomodoro._audioNotification=h.models.audioNotifications},h.restart=function(){h.pomodoro.cancelTimer(),h.states.started=!1,h.timerState=h.setTimerState(),h.time=b.parse(h.pomodoro.getDuration())},h.updateTime=function(d,e){c.setTime(d,e),h.states.started||(h.time=b.parse(h.pomodoro.getDuration()),a.$apply())},a.$on("typeChange",function(a,b){console.log(b),h.states.background=b.type,"break"===b.type||"longBreak"===b.type?h.states.showPro=!0:h.states.showPro=!1,h.models.count=h.pomodoro._count})}]),angular.module("promodoroApp").directive("spacebarListener",["$document",function(a){function b(b){a.on("keydown",function(a){a.keyCode===c&&(b.listener(),b.$apply())})}var c=32;return{restrict:"A",scope:{listener:"&"},link:b}}]),angular.module("promodoroApp").directive("settingsListener",["$document",function(a){function b(b){a.on("keydown",function(a){b.open&&a.keyCode===c&&(b.listener(),b.$apply())})}var c=27;return{restrict:"A",scope:{listener:"&",open:"="},link:b}}]),angular.module("promodoroApp").directive("toggle",function(){return{restrict:"E",scope:{notification:"=",change:"&",label:"@",klass:"@"},template:['<div class="toggle__container {{klass}}">','<p class="toggle__label">{{label}}</p>','<div class="toggle">','<input type="checkbox" class="toggle__checkbox" ng-model="notification" ng-click="change()">','<b class="toggle__switch"></b>','<b class="toggle__track"></b>',"</div>","</div>"].join("")}}),angular.module("promodoroApp").directive("pomodoroRange",function(){function a(a,c){var d=c.find("input");a.perc=b(a.min,a.max,a.time),d.on("input",function(){a.perc=b(a.min,a.max,this.value),a.$apply()}),d.on("change",function(){a.update({timer:String(a.timer),time:Number(a.time)})})}function b(a,b,c){return 100*((c-a)/(b-a))}var c=['<div class="pomodoro-range__container">','<p class="pomodoro__label">{{label}}</p>','<input class="pomodoro__range pomodoro__range--{{timer}}" type="range" min="{{min}}" max="{{max}}" step="{{step}}" ng-model="time">','<span class="pomodoro__time">{{time}}</span>',"<style>.pomodoro__range--{{timer}}::-webkit-slider-runnable-track{background-size:{{perc}}% 100%</style>","</div>"].join("");return{restrict:"E",scope:{min:"@",max:"@",step:"@",label:"@",timer:"@",time:"=",update:"&"},template:c,link:a}}),angular.module("promodoroApp").factory("Notifier",["$window","$timeout",function(a,b){function c(a){this.settings=a||{},this.permission=!1,this._notifaction=null,this._audio=new Audio(d.sound)}var d={title:"promodoroApp",tag:"promodoroApp",dismiss:3e3,sound:"../../audio/alarm.mp3",icon:"../../images/clock.png"};return c.prototype.isSupported=function(){return"Notification"in a},c.prototype.grantPermission=function(){var a=this;Notification.requestPermission(function(b){a.permission="granted"===b})},c.prototype.setNotifaction=function(a){function c(){e._audio.pause(),e._audio.currentTime=0}var e=this,f=this._notifaction=new Notification(d.title,{body:a,tag:d.tag,icon:d.icon});this._notifaction.onshow=function(){b(f.close.bind(f),d.dismiss)},this._notifaction.onclose=c,this._notifaction.onclick=c},c.prototype.playSound=function(){this._audio.play()},c.prototype.getPermission=function(){return this.permission},c}]),angular.module("promodoroApp").factory("Pomodoro",["Timer","$rootScope","Notifier","TimerSettings",function(a,b,c,d){function e(a){this._callback=a,this._duration=d.getTime("active"),this._count=0,this._isBreak=!1,this._timer=null,this._isPaused=!0,this._notifier=new c,this._desktopNotification=!1,this._audioNotification=!1,this._state="active"}var f;return e.prototype.complete=function(){var a;this._isBreak||this._count++,this._desktopNotification&&this.setDesktopNotification(),this._audioNotification&&this._notifier.playSound(),a=this._isBreak?"active":"break",b.$broadcast("typeChange",{type:a}),this._isBreak=!this._isBreak,this.cancelTimer(),this.start()},e.prototype.start=function(){this._timer||(this._timer=!0,this._isBreak&&this._count%4===0?(f="break",this._state="longBreak"):this._isBreak&&this._count%4!==0?(f="break",this._state="shortBreak"):(f="active",this._state="active"),this.run())},e.prototype.reset=function(){this.cancelTimer(),this.run()},e.prototype.pause=function(){this.cancelTimer()},e.prototype.cancelTimer=function(){this._isPaused=!0,a.clearTimer(),this._timer=!1},e.prototype.resume=function(){this._isPaused=!1,a.startTimer({callback:this._callback,self:this})},e.prototype.run=function(){this._duration=d.getTime(this._state),this._isPaused=!1,a.startTimer({time:this._duration,callback:this._callback,self:this})},e.prototype.getDuration=function(){return d.getTime(this._state)},e.prototype.isPaused=function(){return this._isPaused},e.prototype.noticaftions=function(){return this._notifier.isSupported()},e.prototype.allowNotifaction=function(a,b){this._desktopNotification=a,this._audioNotification=b},e.prototype.setDesktopNotification=function(){this._isBreak?this._notifier.setNotifaction(d.getMsg("active")):this._count%4===0?this._notifier.setNotifaction(d.getMsg("longBreak")):this._notifier.setNotifaction(d.getMsg("shortBreak"))},e}]),angular.module("promodoroApp").service("TimeParser",function(){function a(a){if(isNaN(a))return"";var c,d;return c=b(Math.floor(a/60)),d=b(a-60*c),c+" : "+d}function b(a){return 10>a?"0"+a:a}return{parse:a}}),angular.module("promodoroApp").service("Timer",function(){function a(a){e.postMessage({command:"start",time:a.time}),e.onmessage=function(b){if(b.data.started)return f=b.data.started;switch(b.data.message){case"tick":a.callback.call(this,b.data.time);break;case"complete":a.self.complete.call(a.self)}}}function b(){f&&(e.postMessage({command:"clear"}),e.onmessage=function(a){f=!a.data.cleared})}function c(){return f}var d=new Blob([document.querySelector("#worker").textContent],{type:"text/javascript"}),e=new Worker(window.URL.createObjectURL(d)),f=!1;return{startTimer:a,clearTimer:b,isActive:c}}),angular.module("promodoroApp").service("TimerSettings",["$window","Storage",function(a,b){function c(a,c){return angular.isNumber(c)?(h[a]=Number(c),void b.set(a,c)):!1}function d(a){return 60*h[a]||0}function e(a){var b=h[a];return"active"!==a?"Schnell, schnell "+b+" minuten pr0 surfen!":"Weiter so! Nur noch "+b+" minuten bis zur n√§chsten pr0 session"}function f(a,c){b.set(a,c)}function g(a){return"true"===b.get(a)||!1}var h={shortBreak:b.get("shortBreak")||3,longBreak:b.get("longBreak")||15,active:b.get("active")||25};return{setTime:c,getTime:d,getMsg:e,setNotification:f,getNotification:g}}]),angular.module("promodoroApp").service("Storage",["$window",function(a){function b(b,c){a.localStorage.setItem(b,c)}function c(b){return a.localStorage.getItem(b)}return{set:b,get:c}}]);